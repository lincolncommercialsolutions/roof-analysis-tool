3. Restart the application
""")
    st.markdown("---")
    st.markdown("### About")
    st.info(
        "This tool analyzes roof project bid documents to extract roof-related information from uploaded files. "
        "With AI integration, get intelligent insights, document type classification, and recommendations."
    )

st.markdown("""
Upload multiple bid documents (PDFs for specs/drawings, images for blueprints). 
The app will analyze and summarize only roof-related information.
""")

# File uploader
uploaded_files = st.file_uploader(
    "Upload documents",
    type=['pdf', 'png', 'jpg', 'jpeg'],
    accept_multiple_files=True,
    help="Upload PDFs or images (blueprints, specifications, drawings)"
)

if uploaded_files:
    # Check file sizes
    max_size_bytes = max_file_size * 1024 * 1024
    valid_files = []
    for file in uploaded_files:
        file_size = file.size
        if file_size > max_size_bytes:
            st.warning(f"âš ï¸ {file.name} exceeds {max_file_size}MB limit (size: {file_size / 1024 / 1024:.2f}MB)")
        else:
            valid_files.append(file)
    if not valid_files:
        st.error("No valid files to process!")
        st.stop()
    st.success(f"âœ… Processing {len(valid_files)} file(s)...")
    
    # Process files concurrently for efficiency (handles large/multiple docs)
    results = []
    with st.spinner("Analyzing documents..."):
        with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
            futures = []
            for file in valid_files:
                file_type = "pdf" if file.type == "application/pdf" else "image"
                futures.append(executor.submit(process_file, file, file_type))
            for future in concurrent.futures.as_completed(futures):
                results.append(future.result())
    
    # Comprehensive summary
    all_sq_ft = 0
    all_manufacturers = set()
    all_materials = set()
    all_components = set()
    all_other = set()
    summaries = []
    for result in results:
        summary = f"**File: {result['file_name']}**\n"
        if result.get('error'):
            summary += f"âŒ Error: {result['error']}\n"
        else:
            summary += f"ðŸ“„ Document Type: {result['document_type']} ({result['document_type_reason']})\n"
            if result['sq_ft_total']:
                summary += f"ðŸ“ Total Roofing Square Feet: {result['sq_ft_total']:,.2f} (from matches: {', '.join(result['sq_ft_matches'])})\n"
                all_sq_ft += result['sq_ft_total']
            if result['manufacturers']:
                summary += f"ðŸ­ Accepted Roofing Manufacturers: {', '.join(result['manufacturers'])}\n"
                all_manufacturers.update(result['manufacturers'])
            if result['details']['materials']:
                summary += f"ðŸ›  Materials: {', '.join(result['details']['materials'])}\n"
                all_materials.update(result['details']['materials'])
            if result['details']['components']:
                summary += f"ðŸ”© Components: {', '.join(result['details']['components'])}\n"
                all_components.update(result['details']['components'])
            if result['details']['other']:
                summary += f"â„¹ï¸ Other Info: {', '.join(result['details']['other'])}\n"
                all_other.update(result['details']['other'])
            if result['warranty_info']:
                summary += f"ðŸ“œ Warranty Information: {result['warranty_info'][:500]}{'...' if len(result['warranty_info']) > 500 else ''}\n"
            if show_full_text and result['roof_text']:
                summary += f"\nðŸ“„ Extracted Roof Text:\n{result['roof_text'][:2000]}{'...' if len(result['roof_text']) > 2000 else ''}\n"
        summaries.append(summary)
    
    # Create tabs for better organization
    tab1, tab2, tab3, tab4, tab5, tab6, tab7 = st.tabs(["ðŸ“Š Summary", "ðŸ¤– AI Insights", "ðŸ’¬ Chatbot", "ðŸ“‹ Comparison", "â˜ï¸ Word Cloud", "ðŸ” Search", "ðŸ’¾ Export"])
    
    with tab1:
        st.header("Comprehensive Roof Summary")
        # Aggregated across all files
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("Total Square Feet", f"{all_sq_ft:,.2f}" if all_sq_ft > 0 else "N/A")
        with col2:
            st.metric("Manufacturers Found", len(all_manufacturers))
        with col3:
            st.metric("Files Processed", len(results))
        st.markdown("---")
        if all_manufacturers:
            st.subheader("ðŸ­ Accepted Roofing Manufacturers (All Files)")
            st.write(", ".join(sorted(all_manufacturers)))
        if all_materials:
            st.subheader("ðŸ›  Materials (All Files)")
            st.write(", ".join(sorted(all_materials)))
        if all_components:
            st.subheader("ðŸ”© Components (All Files)")
            st.write(", ".join(sorted(all_components)))
        if all_other:
            st.subheader("â„¹ï¸ Other Info (All Files)")
            st.write(", ".join(sorted(all_other)))
        st.markdown("---")
        # Display individual summaries
        st.subheader("Individual File Summaries")
        for idx, result in enumerate(results):
            with st.container():
                st.markdown(f"### ðŸ“„ {result['file_name']}")
                if result.get('error'):
                    st.error(f"âŒ Error: {result['error']}")
                else:
                    # Create metrics row
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        if result['sq_ft_total']:
                            st.metric("Square Footage", f"{result['sq_ft_total']:,.2f}")
                    with col2:
                        st.metric("Manufacturers", len(result['manufacturers']))
                    with col3:
                        st.metric("Materials", len(result['details']['materials']))
                    # Details in expandable sections
                    with st.expander("ðŸ” Detailed Information", expanded=False):
                        st.write(f"**ðŸ“„ Document Type:** {result['document_type']} ({result['document_type_reason']})")
                        if result['sq_ft_total']:
                            st.write(f"**ðŸ“ Total Square Feet:** {result['sq_ft_total']:,.2f}")
                        if result['sq_ft_matches']:
                            st.write(f"*Found in: {', '.join(result['sq_ft_matches'])}*")
                        if result['manufacturers']:
                            st.write(f"**ðŸ­ Manufacturers:** {', '.join(result['manufacturers'])}")
                        if result['details']['materials']:
                            st.write(f"**ðŸ›  Materials:** {', '.join(result['details']['materials'])}")
                        if result['details']['components']:
                            st.write(f"**ðŸ”© Components:** {', '.join(result['details']['components'])}")
                        if result['details']['other']:
                            st.write(f"**â„¹ï¸ Other:** {', '.join(result['details']['other'])}")
                        if result['warranty_info'] and result['warranty_info'] != "No warranty information found.":
                            st.write(f"**ðŸ“œ Warranty:** {result['warranty_info'][:300]}{'...' if len(result['warranty_info']) > 300 else ''}")
                    if show_full_text and result['full_text']:
                        with st.expander("ðŸ“„ Full Extracted Text"):
                            st.text_area("Full content", result['full_text'], height=200, key=f"full_text_{idx}")
                st.markdown("---")
    
    with tab2:
        st.header("ðŸ¤– AI-Powered Insights")
        if not openai_client:
            st.warning("âš ï¸ OpenAI API key not configured. Please add your API key to the .env file to use AI insights.")
            st.code("OPENAI_API_KEY=your-api-key-here", language="bash")
        else:
            st.info("ðŸ’¡ AI insights powered by " + openai_model)
            # Generate AI analysis for each document
            for idx, result in enumerate(results):
                if result.get('error'):
                    continue
                with st.expander(f"ðŸ” AI Analysis: {result['file_name']}", expanded=(idx == 0)):
                    with st.spinner("Generating AI insights..."):
                        ai_insights = get_ai_analysis(
                            result['full_text'],
                            result['roof_text'],
                            result['sq_ft_total'],
                            result['manufacturers'],
                            result['details'],
                            result['document_type']
                        )
                        if ai_insights:
                            st.markdown(ai_insights)
                        else:
                            st.warning("Unable to generate AI insights for this document.")
    
    with tab3:
        st.header("ðŸ’¬ Document Chatbot")
        if not openai_client:
            st.warning("âš ï¸ OpenAI API key not configured. Chatbot requires API access.")
            st.code("OPENAI_API_KEY=your-api-key-here", language="bash")
        else:
            st.info("Ask questions about your uploaded roof bid documents. Select a document and start chatting!")
            # Document selector
            if results:
                selected_doc = st.selectbox(
                    "Select a document to chat about:",
                    options=range(len(results)),
                    format_func=lambda x: results[x]['file_name']
                )
                doc_data = results[selected_doc]
                # Show quick summary of selected document
                with st.expander("ðŸ“‹ Quick Summary", expanded=False):
                    col1, col2 = st.columns(2)
                    with col1:
                        st.write(f"**Document Type:** {doc_data['document_type']}")
                        if doc_data['sq_ft_total']:
                            st.write(f"**Square Feet:** {doc_data['sq_ft_total']:,.2f}")
                        if doc_data['manufacturers']:
                            st.write(f"**Manufacturers:** {', '.join(doc_data['manufacturers'])}")
                    with col2:
                        if doc_data['details']['materials']:
                            st.write(f"**Materials:** {', '.join(doc_data['details']['materials'])}")
                        if doc_data['details']['components']:
                            st.write(f"**Components:** {', '.join(doc_data['details']['components'])}")
                # Initialize chat history in session state
                if 'chat_history' not in st.session_state:
                    st.session_state.chat_history = {}
                if selected_doc not in st.session_state.chat_history:
                    st.session_state.chat_history[selected_doc] = []
                # Display chat history
                for message in st.session_state.chat_history[selected_doc]:
                    with st.chat_message(message["role"]):
                        st.markdown(message["content"])
                # Chat input
                if prompt := st.chat_input(f"Ask anything about {doc_data['file_name']}..."):
                    # Display user message
                    with st.chat_message("user"):
                        st.markdown(prompt)
                    # Add to history
                    st.session_state.chat_history[selected_doc].append({"role": "user", "content": prompt})
                    # Generate response
                    with st.chat_message("assistant"):
                        with st.spinner("Thinking..."):
                            try:
                                # Prepare context for the chatbot with full text
                                context = f"""Document: {doc_data['file_name']}
Document Type: {doc_data['document_type']}
Square Footage: {doc_data['sq_ft_total'] if doc_data['sq_ft_total'] else 'Not specified'}
Manufacturers: {', '.join(doc_data['manufacturers']) if doc_data['manufacturers'] else 'None found'}
Materials: {', '.join(doc_data['details']['materials']) if doc_data['details']['materials'] else 'None found'}
Components: {', '.join(doc_data['details']['components']) if doc_data['details']['components'] else 'None found'}
Full Document Text (excerpt): {doc_data['full_text'][:8000]}"""
                                # Build messages for API
                                messages = [
                                    {"role": "system", "content": f"You are an expert roof construction analyst. You have access to a roofing bid document and should answer questions about it accurately and helpfully. Base your answers on the full document content provided to avoid mixing information.\n\n{context}"},
                                ]
                                # Add chat history (last 5 exchanges to keep context manageable)
                                for msg in st.session_state.chat_history[selected_doc][-10:]:
                                    messages.append({"role": msg["role"], "content": msg["content"]})
                                response = openai_client.chat.completions.create(
                                    model=openai_model,
                                    messages=messages,
                                    temperature=0.7,
                                    max_tokens=800,
                                    stream=True
                                )
                                # Stream the response
                                response_text = ""
                                placeholder = st.empty()
                                for chunk in response:
                                    if chunk.choices[0].delta.content is not None:
                                        response_text += chunk.choices[0].delta.content
                                        placeholder.markdown(response_text)
                                # Add to history
                                st.session_state.chat_history[selected_doc].append({"role": "assistant", "content": response_text})
                            except Exception as e:
                                error_msg = f"Error generating response: {e}"
                                st.error(error_msg)
                                st.session_state.chat_history[selected_doc].append({"role": "assistant", "content": error_msg})
                # Clear chat button
                if st.session_state.chat_history[selected_doc]:
                    if st.button("ðŸ—‘ï¸ Clear Chat History"):
                        st.session_state.chat_history[selected_doc] = []
                        st.rerun()
    
    with tab4:
        st.header("ðŸ“‹ Comparison Across Documents")
        comparison_data = {
            "File": [r['file_name'] for r in results],
            "Type": [r['document_type'] or "Unknown" for r in results],
            "Sq Ft": [f"{r['sq_ft_total']:,.2f}" if r['sq_ft_total'] else "N/A" for r in results],
            "Manufacturers": [", ".join(r['manufacturers']) or "N/A" for r in results],
            "Materials": [", ".join(r['details']['materials']) or "N/A" for r in results],
            "Components": [", ".join(r['details']['components']) or "N/A" for r in results],
            "Warranty": ["Yes" if r['warranty_info'] and r['warranty_info'] != "No warranty information found." else "No" for r in results]
        }
        df = pd.DataFrame(comparison_data)
        st.dataframe(df, use_container_width=True)
        # Download comparison as CSV
        csv = df.to_csv(index=False)
        st.download_button(
            label="ðŸ“¥ Download Comparison (CSV)",
            data=csv,
            file_name="roof_comparison.csv",
            mime="text/csv"
        )
    
    with tab5:
        st.header("â˜ï¸ Roof-Related Word Cloud")
        agg_roof_text = " ".join([r['roof_text'] for r in results if r['roof_text']])
        if agg_roof_text and len(agg_roof_text.strip()) > 0:
            fig = generate_wordcloud(agg_roof_text)
            if fig:
                st.pyplot(fig)
        else:
            st.warning("No text available to generate word cloud")
    
    with tab6:
        st.header("ðŸ” Search Within Extracted Roof Text")
        search_query = st.text_input("Enter search term (e.g., 'warranty', 'GAF', 'TPO')")
        if search_query:
            found_results = False
            for result in results:
                if result['full_text'] and search_query.lower() in result['full_text'].lower():  # Search full text to avoid missing
                    found_results = True
                    st.subheader(f"ðŸ“„ {result['file_name']}")
                    # Highlight search term
                    highlighted = re.sub(
                        f"({re.escape(search_query)})",
                        r"**\1**",
                        result['full_text'][:2000],
                        flags=re.IGNORECASE
                    )
                    st.markdown(highlighted + ("..." if len(result['full_text']) > 2000 else ""))
                    st.markdown("---")
            if not found_results:
                st.info(f"No results found for '{search_query}'")
    
    with tab7:
        st.header("ðŸ’¾ Export Summary")
        # Prepare full summary text
        agg_summary = "ROOF PROJECT BID ANALYSIS SUMMARY\n"
        agg_summary += "=" * 50 + "\n\n"
        agg_summary += f"Total Files Analyzed: {len(results)}\n"
        if all_sq_ft > 0:
            agg_summary += f"Total Roofing Square Feet: {all_sq_ft:,.2f}\n"
        if all_manufacturers:
            agg_summary += f"Accepted Roofing Manufacturers: {', '.join(sorted(all_manufacturers))}\n"
        if all_materials:
            agg_summary += f"Materials: {', '.join(sorted(all_materials))}\n"
        if all_components:
            agg_summary += f"Components: {', '.join(sorted(all_components))}\n"
        if all_other:
            agg_summary += f"Other Info: {', '.join(sorted(all_other))}\n"
        agg_summary += "\n" + "-" * 50 + "\n\n"
        full_summary_text = agg_summary + "\n".join(summaries)
        col1, col2 = st.columns(2)
        with col1:
            st.download_button(
                label="ðŸ“„ Download as TXT",
                data=full_summary_text,
                file_name="roof_summary.txt",
                mime="text/plain"
            )
        with col2:
            pdf_buffer = generate_pdf(full_summary_text)
            if pdf_buffer:
                st.download_button(
                    label="ðŸ“‘ Download as PDF",
                    data=pdf_buffer,
                    file_name="roof_summary.pdf",
                    mime="application/pdf"
                )
        st.markdown("---")
        st.subheader("Preview")
        st.text_area("Summary Preview", full_summary_text, height=300)
else:
    # Show instructions when no files uploaded
    st.info("ðŸ‘† Upload PDF or image files to begin analysis")

# Footer
st.markdown("---")
st.markdown("*Developed for roof project bid analysis | Powered by Streamlit, spaCy, EasyOCR & OpenAI*")